# Mailserver behind Proxy

## [Using `docker-mailserver` behind a Proxy](https://docker-mailserver.github.io/docker-mailserver/edge/examples/tutorials/mailserver-behind-proxy/#using-docker-mailserver-behind-a-proxy)

### [Information](https://docker-mailserver.github.io/docker-mailserver/edge/examples/tutorials/mailserver-behind-proxy/#information)

If you are hiding your container behind a proxy service you might have discovered that the proxied requests from now on contain the proxy IP as the request origin. Whilst this behavior is technical correct it produces certain problems on the containers behind the proxy as they cannot distinguish the real origin of the requests anymore.

To solve this problem on TCP connections we can make use of the [proxy protocol](https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt). Compared to other workarounds that exist (`X-Forwarded-For` which only works for HTTP requests or `Tproxy` that requires you to recompile your kernel) the proxy protocol:

- It is protocol agnostic (can work with any layer 7 protocols, even when encrypted).
- It does not require any infrastructure changes.
- NAT-ing firewalls have no impact it.
- It is scalable.

There is only one condition: **both endpoints** of the connection MUST be compatible with proxy protocol.

Luckily `dovecot` and `postfix` are both Proxy-Protocol ready softwares so it depends only on your used reverse-proxy / loadbalancer.

### [Configuration of the used Proxy Software](https://docker-mailserver.github.io/docker-mailserver/edge/examples/tutorials/mailserver-behind-proxy/#configuration-of-the-used-proxy-software)

The configuration depends on the used proxy system. I will provide the configuration examples of [traefik v2](https://traefik.io/) using IMAP and SMTP with implicit TLS.

Feel free to add your configuration if you achieved the same goal using different proxy software below:

<details open="" style="box-sizing: inherit; display: flow-root; overflow: visible; padding: 0px 0.6rem; background-color: var(--md-admonition-bg-color); border-width: 0px 0px 0px 0.2rem; border-style: solid; border-color: rgb(68, 138, 255); border-image: initial; border-radius: 0.1rem; box-shadow: var(--md-shadow-z1); color: rgb(233, 235, 252); font-size: 0.64rem; margin: 1.5625em 0px; break-inside: avoid; font-family: Roboto, -apple-system, BlinkMacSystemFont, Helvetica, Arial, sans-serif; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"><summary style="box-sizing: border-box; cursor: pointer; display: block; min-height: 1rem; background-color: rgba(68, 138, 255, 0.1); border-top: none; border-right: none; border-bottom: none; border-left: 0.2rem none; border-image: initial; font-weight: 700; margin: 0px -0.6rem 0px -0.8rem; padding: 0.4rem 0.6rem 0.4rem 2.2rem; position: relative; border-top-left-radius: 0.1rem; border-top-right-radius: 0.1rem; -webkit-tap-highlight-color: transparent; outline: none;">Traefik v2</summary><p style="box-sizing: border-box;">Truncated configuration of traefik itself:</p><div class="highlight" style="box-sizing: border-box;"><pre id="__code_1" style="box-sizing: inherit; color: var(--md-code-fg-color); font-feature-settings: &quot;kern&quot;; font-family: var(--md-code-font-family); margin-bottom: 1em; margin-top: 1em; direction: ltr; display: flow-root; line-height: 1.4; position: relative;"><span style="box-sizing: inherit;"></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_1 > code" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; background: transparent; border: 0px; font-family: inherit; font-size: inherit; margin: 0px; padding: 0px; border-radius: 0.1rem; color: var(--md-default-fg-color--lightest); cursor: pointer; height: 1.5em; outline: none; outline-offset: 0.1rem; position: absolute; right: 0.5em; top: 0.5em; transition: color 0.25s ease 0s; width: 1.5em; z-index: 1;"></button><code style="box-sizing: inherit; color: var(--md-code-fg-color); font-feature-settings: &quot;kern&quot;; font-family: var(--md-code-font-family); direction: ltr; background-color: var(--md-code-bg-color); border-radius: 0.1rem; -webkit-box-decoration-break: slice; font-size: 0.85em; padding: 0.772059em 1.17647em; word-break: normal; box-shadow: none; display: block; margin: 0px; outline: none; overflow: auto; touch-action: auto; -webkit-tap-highlight-color: transparent;"><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">version</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">'3.8'</span><span class="w" style="box-sizing: inherit;"></span>
<span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">services</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">  </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">reverse-proxy</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">    </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">image</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"> </span><span class="l l-Scalar l-Scalar-Plain" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">docker.io/traefik:latest</span><span class="w" style="box-sizing: inherit;"> </span><span class="c1" style="box-sizing: inherit; color: var(--md-code-hl-comment-color);"># v2.5</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">    </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">container_name</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"> </span><span class="l l-Scalar l-Scalar-Plain" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">docker-traefik</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">    </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">restart</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"> </span><span class="l l-Scalar l-Scalar-Plain" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">always</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">    </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">command</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"--providers.docker"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"--providers.docker.exposedbydefault=false"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"--providers.docker.network=proxy"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"--entrypoints.web.address=:80"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"--entryPoints.websecure.address=:443"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"--entryPoints.smtp.address=:25"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"--entryPoints.smtp-ssl.address=:465"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"--entryPoints.imap-ssl.address=:993"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"--entryPoints.sieve.address=:4190"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">    </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">ports</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"25:25"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"465:465"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"993:993"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"4190:4190"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">[</span><span class="nv" style="box-sizing: inherit; color: var(--md-code-hl-variable-color);">...</span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">]</span><span class="w" style="box-sizing: inherit;"></span>
</code></pre></div><p style="box-sizing: border-box;">Truncated list of necessary labels on the<span>&nbsp;</span><code style="box-sizing: inherit; color: var(--md-code-fg-color); font-feature-settings: &quot;kern&quot;; font-family: var(--md-code-font-family); direction: ltr; background-color: var(--md-code-bg-color); border-radius: 0.1rem; -webkit-box-decoration-break: clone; font-size: 0.85em; padding: 0px 0.294118em; word-break: break-word; -webkit-tap-highlight-color: transparent; outline: none;">docker-mailserver</code><span>&nbsp;</span>container:</p><div class="highlight" style="box-sizing: border-box;"><pre id="__code_2" style="box-sizing: inherit; color: var(--md-code-fg-color); font-feature-settings: &quot;kern&quot;; font-family: var(--md-code-font-family); margin-bottom: 1em; margin-top: 1em; direction: ltr; display: flow-root; line-height: 1.4; position: relative;"><span style="box-sizing: inherit;"></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_2 > code" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; background: transparent; border: 0px; font-family: inherit; font-size: inherit; margin: 0px; padding: 0px; border-radius: 0.1rem; color: var(--md-default-fg-color--lightest); cursor: pointer; height: 1.5em; outline: none; outline-offset: 0.1rem; position: absolute; right: 0.5em; top: 0.5em; transition: color 0.25s ease 0s; width: 1.5em; z-index: 1;"></button><code style="box-sizing: inherit; color: var(--md-code-fg-color); font-feature-settings: &quot;kern&quot;; font-family: var(--md-code-font-family); direction: ltr; background-color: var(--md-code-bg-color); border-radius: 0.1rem; -webkit-box-decoration-break: slice; font-size: 0.85em; padding: 0.772059em 1.17647em; word-break: normal; box-shadow: none; display: block; margin: 0px; outline: none; overflow: auto; touch-action: auto; -webkit-tap-highlight-color: transparent;"><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">version</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">'3.8'</span><span class="w" style="box-sizing: inherit;"></span>
<span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">services</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">  </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">mailserver</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">    </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">image</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"> </span><span class="l l-Scalar l-Scalar-Plain" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">docker.io/mailserver/docker-mailserver:latest</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">    </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">container_name</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"> </span><span class="l l-Scalar l-Scalar-Plain" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">mailserver</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">    </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">hostname</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"> </span><span class="l l-Scalar l-Scalar-Plain" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">mail</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">    </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">domainname</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"> </span><span class="l l-Scalar l-Scalar-Plain" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">example.com</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">    </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">restart</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"> </span><span class="l l-Scalar l-Scalar-Plain" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">always</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">    </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">networks</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="l l-Scalar l-Scalar-Plain" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">proxy</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">    </span><span class="nt" style="box-sizing: inherit; color: var(--md-code-hl-keyword-color);">labels</span><span class="p" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">:</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.enable=true"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.smtp.rule=HostSNI(`*`)"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.smtp.entrypoints=smtp"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.smtp.service=smtp"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.services.smtp.loadbalancer.server.port=25"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.services.smtp.loadbalancer.proxyProtocol.version=1"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.smtp-ssl.rule=HostSNI(`*`)"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.smtp-ssl.tls=false"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.smtp-ssl.entrypoints=smtp-ssl"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.smtp-ssl.service=smtp-ssl"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.services.smtp-ssl.loadbalancer.server.port=465"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.services.smtp-ssl.loadbalancer.proxyProtocol.version=1"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.imap-ssl.rule=HostSNI(`*`)"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.imap-ssl.entrypoints=imap-ssl"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.imap-ssl.service=imap-ssl"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.services.imap-ssl.loadbalancer.server.port=10993"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.services.imap-ssl.loadbalancer.proxyProtocol.version=2"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.sieve.rule=HostSNI(`*`)"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.sieve.entrypoints=sieve"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.routers.sieve.service=sieve"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="w" style="box-sizing: inherit;">      </span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">-</span><span class="w" style="box-sizing: inherit;"> </span><span class="s" style="box-sizing: inherit; color: var(--md-code-hl-string-color);">"traefik.tcp.services.sieve.loadbalancer.server.port=4190"</span><span class="w" style="box-sizing: inherit;"></span>
<span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">[</span><span class="nv" style="box-sizing: inherit; color: var(--md-code-hl-variable-color);">...</span><span class="p p-Indicator" style="box-sizing: inherit; color: var(--md-code-hl-punctuation-color);">]</span><span class="w" style="box-sizing: inherit;"></span>
</code></pre></div><p style="box-sizing: border-box; margin-bottom: 0.6rem;">Keep in mind that it is necessary to use port<span>&nbsp;</span><code style="box-sizing: inherit; color: var(--md-code-fg-color); font-feature-settings: &quot;kern&quot;; font-family: var(--md-code-font-family); direction: ltr; background-color: var(--md-code-bg-color); border-radius: 0.1rem; -webkit-box-decoration-break: clone; font-size: 0.85em; padding: 0px 0.294118em; word-break: break-word; -webkit-tap-highlight-color: transparent; outline: none;">10993</code><span>&nbsp;</span>here. More information below at<span>&nbsp;</span><code style="box-sizing: inherit; color: var(--md-code-fg-color); font-feature-settings: &quot;kern&quot;; font-family: var(--md-code-font-family); direction: ltr; background-color: var(--md-code-bg-color); border-radius: 0.1rem; -webkit-box-decoration-break: clone; font-size: 0.85em; padding: 0px 0.294118em; word-break: break-word; -webkit-tap-highlight-color: transparent; outline: none;">dovecot</code><span>&nbsp;</span>configuration.</p></details>

### [Configuration of the Backend (`dovecot` and `postfix`)](https://docker-mailserver.github.io/docker-mailserver/edge/examples/tutorials/mailserver-behind-proxy/#configuration-of-the-backend-dovecot-and-postfix)

The following changes can be achieved completely by adding the content to the appropriate files by using the projects [function to overwrite config files](https://docker-mailserver.github.io/docker-mailserver/edge/config/advanced/optional-config/).

Changes for `postfix` can be applied by adding the following content to `docker-data/dms/config/postfix-main.cf`:

```
postscreen_upstream_proxy_protocol = haproxy
```

and to `docker-data/dms/config/postfix-master.cf`:

```
submission/inet/smtpd_upstream_proxy_protocol=haproxy
smtps/inet/smtpd_upstream_proxy_protocol=haproxy
```

Changes for `dovecot` can be applied by adding the following content to `docker-data/dms/config/dovecot.cf`:

```
haproxy_trusted_networks = <your-proxy-ip>, <optional-cidr-notation>
haproxy_timeout = 3 secs
service imap-login {
  inet_listener imaps {
    haproxy = yes
    ssl = yes
    port = 10993
  }
}
```

Note

Port `10993` is used here to avoid conflicts with internal systems like `postscreen` and `amavis` as they will exchange messages on the default port and obviously have a different origin then compared to the proxy.